#ES-PUSH

[TOC]

ES-PUSH是一个针对[乐鑫公司™](http://espressif.com)的8266 WIFI物理网芯片开发的推送服务平台，具备实时远程数据推送，数据收集与整理归纳，云端自动推送升级等功能。

ESP8266内置低功耗32位芯片，可兼作应用处理器，同时自带众多GPIO引脚，设置引脚复用后大大方便控制外部设备电路。这使得我们的物联网设备或其他需要wifi网络功能的设备模块无需额外集成CPU即可实现大部分功能，无疑是开发者的福音。

但ESP8266使用的TCP/IP编程与通常的Socket方式不同，其网络控制结构`struct espconn`基于对lwip的浅层封装实现，使用异步回调机制，给开发带来了诸多不变，往常的大量的基于socket的网络编程库与经验得不到重复使用。故此开发了这样一个数据推送平台。以期能为开发者分忧。

ES-PUSH只希望解决一个问题，即能在任何有网络的地方随时控制处于内网中的WIFI设备，譬如在公司里控制家里的wifi机器人小车，回家的路上使用4G网络控制家里的热水器开关、空调器开关等。

#使用方式
平台支持多种使用方式，如您使用乐鑫提供的SDK自定义设备工作方式，则可使用SDK的方式，集成我们的C库即可。若您直接使用乐鑫提供的AT固件，使用外部逻辑控制模块，则可使用我们定制的AT固件，新增了用于数据推送与连接管理的AT命令，使用更简单。

##如何刷入固件
点击此处下载ESP8266一键刷写工具，此工具有NodeMCU开发。ES-PUSH的NodeMCU版本亦在开发中。

##SDK方式
客户端的使用方式极为简单，克隆此[github库](https://github.com/pushdotccgzs/esp_push_example)，使用

`make clean && make BOOT=new APP=1`

即可编译出user1，同理使用

`make clean && make BOOT=new APP=2`

即可编译出user2.

本质上只是在[乐鑫官方库](http://bbs.espressif.com/viewtopic.php?f=5&t=321)的基础上增加了用于推送的`libpush`库，如果开发者使用如安信可IDE等，可直接编译出对应的flash rom。
##AT固件方式
如果您只是将ESP8266芯片用作您的网络用途，那AT固件是您最好的选择，点击此处下载ES-PUSH的AT固件，并按下图所示刷入您的设备中。

AT-PUSH固件新增了3个命令，以下做简要说明
- AT+PUSH，使用AT+PUSH?可查询当前连接状态，返回值定义为：
```
CONNECTING = 0
DNS_LOOKUP = 1
CONNECTED = 2
DISCONNECTED = 3
```
留意只有返回值为 `2` 时才代表已连接，其余都是未连接状态，如连接中，DNS查找中，已断开等。

同时，使用`AT+PUSH=APPID,APPKEY`可连入ES-PUSH系统。命令为异步式，敲入后立即返回，可随时使用AT+PUSH?查询连接状态，当处于可连接时，能使用如下命令。
- AT+PUSHMSG，数据推送，距离推送HELLO字符串到服务器可发送指令`AT+PUSHMSG=HELLO`即可。在与服务器正常连接的情况下返回OK，否则返回ERROR。

- AT+UNPUSH，使用此命令断开与服务器的连接，断开后服务端也将无法推送数据到终端。返回OK。
- +MSG，收到数据后，模块将向串口写入以下数据，数据已`+MSG %d:`开头，其中%d为

##NodeMCU版
未完成，请稍候

#实时远程数据推送
平台可实时针对单个设备、或按应用区分的某种指定类型所属设备进行自定义数据推送，推送的数据在模块上以回调函数的方式被定义（SDK方式）或串口输出（AT固件），您可以再此基础上定义自己的各项功能，如发送特殊指令以实现GPIO使能、控制串口通讯、驱动PWM、重启模块等操作。GPIO使能如简单的点亮LED、复杂的如控制各种外围设备等。

#数据收集与整理归纳
客户端可随时复用ESPUSH的连接向服务端推送数据，如各项传感器的数值、模块工作状态、终端逻辑数据等。上传的数据可通过Web控制台浏览，亦可通过服务端SDK将数据同步回开发者。

#云端自动推送升级
与[乐鑫官方](http://espressif.com)的云服务不同的是，ESPUSH的自动推送升级是在连接保持的基础上，云端控制推送实现升级，以及升级完成后的重启工作，此过程并不需要终端用户的参与。

云端控制台可针对单个设备、所有设备或某种应用类型设备进行，可清晰的观察到设备升级进度及升级结果是否成功，可针对测试设备升级成功后再行规模化推送。

#服务端SDK
未开放，敬请期待。

#注意事项
ESPUSH本质上与现有的推送平台如[信鸽](http://xg.qq.com/)、[个推](http://www.getui.com/)、[极光推送](https://www.jpush.cn/)等类似，均使用TCP长连接协议，通过心跳(KeepAlive)保持，来实现针对在线设备的实时操控。

既然使用到TCP长连接心跳保持技术，这便对设备的能耗提出了更多的要求，设备将不得断开网络，这将意味着您无法使用ESP8266的`深度睡眠`功能。

同时对设备的网络模式提出了要求，不得处于SoftAP模式，如若处于AP模式则芯片将不能正常访问外部Internet网络，将无法通过云端对其进行实时操控。当您需要退出实时操控时，请调用`push_unregister`函数，芯片将断开与云端的连接，同时云端亦将无法再行控制设备，各种服务端SDK对设备的操作如数据推送、云端推送升级等亦将失败。

